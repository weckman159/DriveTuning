generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// NextAuth Models

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  accounts      Account[]
  sessions      Session[]
  privacySettings UserPrivacySettings?
  profile       UserProfile?
  garages       Garage[]
  partListings  PartListing[]
  marketBuyerConversations MarketConversation[] @relation("MarketConversationBuyer")
  marketSellerConversations MarketConversation[] @relation("MarketConversationSeller")
  marketMessages MarketMessage[]
  marketOffers   MarketOffer[]
  marketBuyOrders MarketOrder[] @relation("MarketOrderBuyer")
  marketSellOrders MarketOrder[] @relation("MarketOrderSeller")
  stripeConnectAccount StripeConnectAccount?
  eventAttendances EventAttendance[]
  documents     Document[]
  legalityContributions LegalityContribution[]
  shareLinks    ShareLink[]
  passwordResets PasswordResetToken[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? 
  access_token       String? 
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? 
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model ApiRateLimit {
  id        String   @id @default(cuid())
  key       String   @unique
  count     Int      @default(0)
  resetAt   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resetAt])
}

// Enums



// Application Models

model UserPrivacySettings {
  id                String    @id @default(cuid())
  userId            String    @unique
  hideGarageLocation Boolean  @default(true)
  autoBlurPlates    Boolean   @default(true)
  showRealName      Boolean   @default(false)
  defaultCarVisibility String @default("UNLISTED")
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  username          String?  @unique
  usernameChangedAt DateTime?

  bio       String?
  location  String?
  website   String?
  instagram String?
  twitter   String?
  youtube   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([username])
}

model Brand {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())

  models CarModel[]
}

model CarModel {
  id        String   @id @default(cuid())
  brandId   String
  name      String
  createdAt DateTime @default(now())

  brand    Brand       @relation(fields: [brandId], references: [id], onDelete: Cascade)
  variants CarVariant[]

  @@unique([brandId, name])
  @@index([brandId])
}

model CarVariant {
  id          String   @id @default(cuid())
  carModelId  String
  fingerprint String   @unique
  generation  String?
  bodyCode    String?
  engineCode  String?
  hsn         String?
  tsn         String?
  createdAt   DateTime @default(now())

  carModel CarModel @relation(fields: [carModelId], references: [id], onDelete: Cascade)
  cars     Car[]

  @@index([carModelId])
}

model Garage {
  id        String   @id @default(cuid())
  userId    String
  name      String   
  region    String   
  isDefault Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cars      Car[]
}

model Car {
  id            String      @id @default(cuid())
  slug          String?     @unique
  garageId      String
  make          String      
  model         String      
  generation    String?     
  bodyCode      String?
  hsn           String?
  tsn           String?
  carVariantId  String?
  year          Int?
  stateId        String?
  registrationPlate String?
  transmission  String?
  engineCode    String?     
  factoryHp     Int?
  factoryWeight Int?
  projectGoal   String
  buildStatus   String @default("IN_PROGRESS")
  currentMileage Int?
  visibility    String @default("UNLISTED")
  heroImage     String?
  frontImage    String?
  rearImage     String?
  interiorImage String?
  forSale       Boolean     @default(false)
  askingPrice   Float?    
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  garage        Garage      @relation(fields: [garageId], references: [id], onDelete: Cascade)
  carVariant    CarVariant? @relation(fields: [carVariantId], references: [id], onDelete: SetNull)
  logEntries     LogEntry[]
  partListings   PartListing[]
  eventAttendances EventAttendance[]
  documents      Document[]
  shareLinks     ShareLink[]
  tasks          BuildTask[]

  @@index([stateId])
}

model BuildTask {
  id          String   @id @default(cuid())
  carId       String
  title       String
  description String?
  category    String?
  status      String   @default("TODO") // TODO | IN_PROGRESS | DONE
  dueAt       DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  car Car @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@index([carId])
  @@index([status])
  @@index([dueAt])
}

// Journal Enums





// Journal Models

model LogEntry {
  id            String          @id @default(cuid())
  carId         String
  // Element-level visibility for Build Passport views: NONE | SELF | LINK | PUBLIC
  visibility    String          @default("SELF")
  type          String
  title         String          
  description   String?
  date          DateTime
  totalCostImpact Float?      
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  car           Car             @relation(fields: [carId], references: [id], onDelete: Cascade)
  media         LogEntryMedia[]
  modifications Modification[]
}

model LogEntryMedia {
  id         String    @id @default(cuid())
  logEntryId String
  type       String
  url        String

  logEntry   LogEntry  @relation(fields: [logEntryId], references: [id], onDelete: Cascade)
}

model Modification {
  id         String             @id @default(cuid())
  logEntryId String
  partName   String             
  brand      String?            
  category   String
  price      Float?           
  tuvStatus  String
  userParametersJson String?
  installedAt DateTime?
  installedMileage Int?
  removedAt DateTime?
  removedMileage Int?
  evidenceScore Int @default(0)

  // Legality snapshot (DE/EU). Stored as hints/status, not as legal advice.
  legalityStatus         String   @default("UNKNOWN")
  legalityApprovalType   String?
  legalityApprovalNumber String?
  legalitySourceId       String?
  legalitySourceUrl      String?
  legalityNotes          String?
  legalityLastCheckedAt  DateTime?
  legalityReferenceId    String?

  logEntry   LogEntry           @relation(fields: [logEntryId], references: [id], onDelete: Cascade)
  partListings PartListing[]
  documents  Document[]
  approvalDocuments ApprovalDocument[]
  legalityContributions LegalityContribution[]
  legalityReference LegalityReference? @relation(fields: [legalityReferenceId], references: [id], onDelete: SetNull)

  @@index([legalityStatus])
  @@index([legalityApprovalType])
  @@index([legalityApprovalNumber])
  @@index([legalityReferenceId])
}

model LegalityReference {
  id                  String   @id @default(cuid())
  fingerprint          String   @unique
  brand               String
  partName             String
  category             String
  subcategory          String?
  vehicleCompatibility String?
  approvalType         String
  approvalNumber       String?
  sourceId             String
  sourceUrl            String?
  restrictionsJson     String?
  notesDe              String?
  notesEn              String?
  validFrom            DateTime?
  validUntil           DateTime?
  isSynthetic          Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  modifications Modification[]

  @@index([brand])
  @@index([category])
  @@index([subcategory])
  @@index([approvalType])
  @@index([approvalNumber])
}

model LegalityContribution {
  id              String   @id @default(cuid())
  userId          String
  modificationId  String
  approvalType    String
  approvalNumber  String?
  inspectionOrg   String
  inspectionDate  DateTime
  notes           String?
  status          String   @default("PENDING") // PENDING | APPROVED | REJECTED
  isAnonymous     Boolean  @default(true)
  hasDocuments    Boolean  @default(false)
  reviewedAt      DateTime?
  reviewedBy      String?
  rejectionReason String?
  createdAt       DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  modification Modification @relation(fields: [modificationId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([modificationId])
  @@index([userId])
  @@index([createdAt])
}

// Marketplace Enums



// Marketplace Models

model PartListing {
  id             String        @id @default(cuid())
  sellerId       String
  carId          String?
  modificationId String?
  title          String        
  description    String?
  price          Float       
  condition      String
  mileageOnCar   Int?
  // Legality snapshot (DE/EU) for marketplace listing. Copied from linked Modification.
  legalityStatus         String   @default("UNKNOWN")
  legalityApprovalType   String?
  legalityApprovalNumber String?
  legalitySourceId       String?
  legalitySourceUrl      String?
  legalityNotes          String?
  legalityLastCheckedAt  DateTime?
  isFullyLegal           Boolean  @default(false)
  requiresRegistration   Boolean  @default(false)
  requiresInspection     Boolean  @default(false)
  status         String    @default("ACTIVE")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  seller         User          @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  car            Car?          @relation(fields: [carId], references: [id])
  modification   Modification? @relation(fields: [modificationId], references: [id])
  media          PartListingMedia[]
  shareLinks     ShareLink[]
  marketConversations MarketConversation[]
  orders         MarketOrder[]

  @@index([legalityStatus])
  @@index([legalityApprovalType])
  @@index([legalityApprovalNumber])
  @@index([isFullyLegal])
  @@index([requiresRegistration])
  @@index([requiresInspection])
}

model PartListingMedia {
  id           String       @id @default(cuid())
  partListingId String
  type         String
  url          String

  partListing  PartListing  @relation(fields: [partListingId], references: [id], onDelete: Cascade)
}

model MarketConversation {
  id            String   @id @default(cuid())
  partListingId String
  buyerId       String
  sellerId      String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  partListing PartListing @relation(fields: [partListingId], references: [id], onDelete: Cascade)
  buyer       User        @relation("MarketConversationBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  seller      User        @relation("MarketConversationSeller", fields: [sellerId], references: [id], onDelete: Cascade)
  messages    MarketMessage[]
  offers      MarketOffer[]

  @@unique([partListingId, buyerId])
  @@index([sellerId])
  @@index([buyerId])
  @@index([partListingId])
}

model MarketMessage {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  body           String
  createdAt      DateTime @default(now())

  conversation MarketConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User              @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model MarketOffer {
  id             String   @id @default(cuid())
  conversationId String
  createdById    String
  amountCents    Int
  currency       String   @default("EUR")
  status         String   @default("PENDING") // PENDING | ACCEPTED | DECLINED | CANCELLED
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  conversation MarketConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  createdBy    User              @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdById])
  @@index([status])
}

model StripeConnectAccount {
  id               String   @id @default(cuid())
  userId           String   @unique
  stripeAccountId  String   @unique
  chargesEnabled   Boolean  @default(false)
  payoutsEnabled   Boolean  @default(false)
  detailsSubmitted Boolean  @default(false)
  verificationStatus String @default("PENDING") // PENDING | VERIFIED | REJECTED
  verifiedAt       DateTime?
  rejectedAt       DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MarketOrder {
  id                     String   @id @default(cuid())
  partListingId          String
  buyerId                String
  sellerId               String
  amountCents            Int
  currency               String   @default("EUR")
  status                 String   @default("PENDING_PAYMENT") // PENDING_PAYMENT | PAID | CANCELLED | REFUNDED
  stripeCheckoutSessionId String?  @unique
  stripePaymentIntentId  String?  @unique
  paidAt                 DateTime?
  cancelledAt            DateTime?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  partListing PartListing @relation(fields: [partListingId], references: [id], onDelete: Cascade)
  buyer       User        @relation("MarketOrderBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  seller      User        @relation("MarketOrderSeller", fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([partListingId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([createdAt])
}

model StripeWebhookEvent {
  id            String   @id @default(cuid())
  stripeEventId String   @unique
  type          String
  processingAt  DateTime?
  processedAt   DateTime?
  createdAt     DateTime @default(now())

  @@index([createdAt])
  @@index([type])
}

model Document {
  id             String        @id @default(cuid())
  ownerId        String
  modificationId String?
  carId          String?
  // Element-level visibility for Build Passport views: NONE | SELF | LINK | PUBLIC
  visibility     String        @default("SELF")
  type           String
  status         String        @default("UPLOADED")
  title          String?
  issuer         String?
  documentNumber String?
  url            String
  uploadedAt     DateTime      @default(now())

  owner          User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  modification   Modification? @relation(fields: [modificationId], references: [id], onDelete: Cascade)
  car            Car?          @relation(fields: [carId], references: [id], onDelete: Cascade)
  approvalDocument ApprovalDocument?
}

model ApprovalDocument {
  id               String   @id @default(cuid())
  modificationId   String
  documentId       String   @unique
  approvalType     String
  approvalNumber   String?
  issuingAuthority String?
  issueDate        DateTime?
  validUntil       DateTime?
  createdAt        DateTime @default(now())

  modification Modification @relation(fields: [modificationId], references: [id], onDelete: Cascade)
  document     Document     @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([modificationId])
  @@index([approvalType])
}

model ShareLink {
  id            String       @id @default(cuid())
  token         String       @unique
  ownerId       String
  carId         String?
  partListingId String?
  visibility    String       @default("READ_ONLY")
  expiresAt     DateTime?
  revokedAt     DateTime?
  createdAt     DateTime     @default(now())

  owner         User         @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  car           Car?         @relation(fields: [carId], references: [id], onDelete: Cascade)
  partListing   PartListing? @relation(fields: [partListingId], references: [id], onDelete: Cascade)
  views         ShareLinkView[]
}

model ShareLinkView {
  id          String   @id @default(cuid())
  shareLinkId String
  viewedAt    DateTime @default(now())
  viewerHash  String?
  userAgent   String?

  shareLink   ShareLink @relation(fields: [shareLinkId], references: [id], onDelete: Cascade)

  @@index([shareLinkId])
  @@index([viewedAt])
}

// Events Enums



// Events Models

model Event {
  id             String        @id @default(cuid())
  title          String        
  description    String?
  dateStart      DateTime
  dateEnd        DateTime?
  locationRegion String        
  locationName   String        
  stateId        String?
  visibility     String   @default("PUBLIC") // PUBLIC | UNLISTED
  brandFilter    String?       
  status         String   @default("UPCOMING")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  attendances    EventAttendance[]

  @@index([stateId])
  @@index([visibility])
}

model EventAttendance {
  id        String           @id @default(cuid())
  eventId   String
  userId    String
  carId     String
  status    String @default("INTERESTED")

  event     Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  car       Car              @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId, carId])
}

