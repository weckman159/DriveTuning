generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// NextAuth Models

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  accounts      Account[]
  sessions      Session[]
  privacySettings UserPrivacySettings?
  garages       Garage[]
  partListings  PartListing[]
  marketBuyerConversations MarketConversation[] @relation("MarketConversationBuyer")
  marketSellerConversations MarketConversation[] @relation("MarketConversationSeller")
  marketMessages MarketMessage[]
  marketOffers   MarketOffer[]
  marketBuyOrders MarketOrder[] @relation("MarketOrderBuyer")
  marketSellOrders MarketOrder[] @relation("MarketOrderSeller")
  stripeConnectAccount StripeConnectAccount?
  eventAttendances EventAttendance[]
  documents     Document[]
  shareLinks    ShareLink[]
  passwordResets PasswordResetToken[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? 
  access_token       String? 
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? 
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

// Enums



// Application Models

model UserPrivacySettings {
  id                String    @id @default(cuid())
  userId            String    @unique
  hideGarageLocation Boolean  @default(true)
  autoBlurPlates    Boolean   @default(true)
  showRealName      Boolean   @default(false)
  defaultCarVisibility String @default("UNLISTED")
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Garage {
  id        String   @id @default(cuid())
  userId    String
  name      String   
  region    String   
  isDefault Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cars      Car[]
}

model Car {
  id            String      @id @default(cuid())
  slug          String?     @unique
  garageId      String
  make          String      
  model         String      
  generation    String?     
  year          Int?
  engineCode    String?     
  factoryHp     Int?
  factoryWeight Int?
  projectGoal   String
  buildStatus   String @default("IN_PROGRESS")
  currentMileage Int?
  visibility    String @default("UNLISTED")
  heroImage     String?
  frontImage    String?
  rearImage     String?
  interiorImage String?
  forSale       Boolean     @default(false)
  askingPrice   Float?    
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  garage        Garage      @relation(fields: [garageId], references: [id], onDelete: Cascade)
  logEntries     LogEntry[]
  partListings   PartListing[]
  eventAttendances EventAttendance[]
  documents      Document[]
  shareLinks     ShareLink[]
  tasks          BuildTask[]
}

model BuildTask {
  id          String   @id @default(cuid())
  carId       String
  title       String
  description String?
  category    String?
  status      String   @default("TODO") // TODO | IN_PROGRESS | DONE
  dueAt       DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  car Car @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@index([carId])
  @@index([status])
  @@index([dueAt])
}

// Journal Enums





// Journal Models

model LogEntry {
  id            String          @id @default(cuid())
  carId         String
  // Element-level visibility for Build Passport views: NONE | SELF | LINK | PUBLIC
  visibility    String          @default("SELF")
  type          String
  title         String          
  description   String?
  date          DateTime
  totalCostImpact Float?      
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  car           Car             @relation(fields: [carId], references: [id], onDelete: Cascade)
  media         LogEntryMedia[]
  modifications Modification[]
}

model LogEntryMedia {
  id         String    @id @default(cuid())
  logEntryId String
  type       String
  url        String

  logEntry   LogEntry  @relation(fields: [logEntryId], references: [id], onDelete: Cascade)
}

model Modification {
  id         String             @id @default(cuid())
  logEntryId String
  partName   String             
  brand      String?            
  category   String
  price      Float?           
  tuvStatus  String
  installedAt DateTime?
  installedMileage Int?
  removedAt DateTime?
  removedMileage Int?
  evidenceScore Int @default(0)

  logEntry   LogEntry           @relation(fields: [logEntryId], references: [id], onDelete: Cascade)
  partListings PartListing[]
  documents  Document[]
}

// Marketplace Enums



// Marketplace Models

model PartListing {
  id             String        @id @default(cuid())
  sellerId       String
  carId          String?
  modificationId String?
  title          String        
  description    String?
  price          Float       
  condition      String
  mileageOnCar   Int?
  status         String    @default("ACTIVE")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  seller         User          @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  car            Car?          @relation(fields: [carId], references: [id])
  modification   Modification? @relation(fields: [modificationId], references: [id])
  media          PartListingMedia[]
  shareLinks     ShareLink[]
  marketConversations MarketConversation[]
  orders         MarketOrder[]
}

model PartListingMedia {
  id           String       @id @default(cuid())
  partListingId String
  type         String
  url          String

  partListing  PartListing  @relation(fields: [partListingId], references: [id], onDelete: Cascade)
}

model MarketConversation {
  id            String   @id @default(cuid())
  partListingId String
  buyerId       String
  sellerId      String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  partListing PartListing @relation(fields: [partListingId], references: [id], onDelete: Cascade)
  buyer       User        @relation("MarketConversationBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  seller      User        @relation("MarketConversationSeller", fields: [sellerId], references: [id], onDelete: Cascade)
  messages    MarketMessage[]
  offers      MarketOffer[]

  @@unique([partListingId, buyerId])
  @@index([sellerId])
  @@index([buyerId])
  @@index([partListingId])
}

model MarketMessage {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  body           String
  createdAt      DateTime @default(now())

  conversation MarketConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User              @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model MarketOffer {
  id             String   @id @default(cuid())
  conversationId String
  createdById    String
  amountCents    Int
  currency       String   @default("EUR")
  status         String   @default("PENDING") // PENDING | ACCEPTED | DECLINED | CANCELLED
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  conversation MarketConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  createdBy    User              @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdById])
  @@index([status])
}

model StripeConnectAccount {
  id               String   @id @default(cuid())
  userId           String   @unique
  stripeAccountId  String   @unique
  chargesEnabled   Boolean  @default(false)
  payoutsEnabled   Boolean  @default(false)
  detailsSubmitted Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MarketOrder {
  id                     String   @id @default(cuid())
  partListingId          String
  buyerId                String
  sellerId               String
  amountCents            Int
  currency               String   @default("EUR")
  status                 String   @default("PENDING_PAYMENT") // PENDING_PAYMENT | PAID | CANCELLED | REFUNDED
  stripeCheckoutSessionId String?  @unique
  stripePaymentIntentId  String?  @unique
  paidAt                 DateTime?
  cancelledAt            DateTime?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  partListing PartListing @relation(fields: [partListingId], references: [id], onDelete: Cascade)
  buyer       User        @relation("MarketOrderBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  seller      User        @relation("MarketOrderSeller", fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([partListingId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([createdAt])
}

model StripeWebhookEvent {
  id            String   @id @default(cuid())
  stripeEventId String   @unique
  type          String
  processingAt  DateTime?
  processedAt   DateTime?
  createdAt     DateTime @default(now())

  @@index([createdAt])
  @@index([type])
}

model Document {
  id             String        @id @default(cuid())
  ownerId        String
  modificationId String?
  carId          String?
  // Element-level visibility for Build Passport views: NONE | SELF | LINK | PUBLIC
  visibility     String        @default("SELF")
  type           String
  status         String        @default("UPLOADED")
  title          String?
  issuer         String?
  documentNumber String?
  url            String
  uploadedAt     DateTime      @default(now())

  owner          User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  modification   Modification? @relation(fields: [modificationId], references: [id], onDelete: Cascade)
  car            Car?          @relation(fields: [carId], references: [id], onDelete: Cascade)
}

model ShareLink {
  id            String       @id @default(cuid())
  token         String       @unique
  ownerId       String
  carId         String?
  partListingId String?
  visibility    String       @default("READ_ONLY")
  expiresAt     DateTime?
  revokedAt     DateTime?
  createdAt     DateTime     @default(now())

  owner         User         @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  car           Car?         @relation(fields: [carId], references: [id], onDelete: Cascade)
  partListing   PartListing? @relation(fields: [partListingId], references: [id], onDelete: Cascade)
  views         ShareLinkView[]
}

model ShareLinkView {
  id          String   @id @default(cuid())
  shareLinkId String
  viewedAt    DateTime @default(now())
  viewerHash  String?
  userAgent   String?

  shareLink   ShareLink @relation(fields: [shareLinkId], references: [id], onDelete: Cascade)

  @@index([shareLinkId])
  @@index([viewedAt])
}

// Events Enums



// Events Models

model Event {
  id             String        @id @default(cuid())
  title          String        
  description    String?
  dateStart      DateTime
  dateEnd        DateTime?
  locationRegion String        
  locationName   String        
  brandFilter    String?       
  status         String   @default("UPCOMING")
  createdAt      DateTime      @default(now())

  attendances    EventAttendance[]
}

model EventAttendance {
  id        String           @id @default(cuid())
  eventId   String
  userId    String
  carId     String
  status    String @default("INTERESTED")

  event     Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  car       Car              @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId, carId])
}

