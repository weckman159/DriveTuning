# Tasks for 2026-02-07 (Sat)

Context: DriveTuning Build Passport (Germany/EU). Focus: evidence chain + privacy-by-default.

## Status Snapshot (repo state as of 2026-02-07)
- ✅ `/build/[slug]` exists and enforces build-level access:
  - PUBLIC: no token required
  - UNLISTED: valid token required
  - PRIVATE: owner-only (never via token)
- ✅ Share link creation + listing exists (`app/api/cars/[id]/share-links/*`) and UI uses it on `app/cars/[id]/page.tsx`.
- ✅ Consent logging table exists (`ShareLinkView`) and `/build/[slug]` writes a view on token-based access.
- ✅ `BuildTask` exists and is rendered (owner-only) on `/build/[slug]` and `/cars/[id]`.
- ✅ Element-level privacy implemented:
  - `Document.visibility` + `LogEntry.visibility` exist in BOTH Prisma schemas (default `SELF`).
  - `/build/[slug]` filters `documents` + `logEntries` for public vs link vs owner views.
- ✅ View logging dedup/throttling implemented (same `viewerHash` for same `shareLinkId` within 10 minutes is ignored).
- ✅ Runtime validation for controlled vocab centralized in `lib/vocab.ts` and applied to the main write paths.
- ✅ `npm run lint` and `npm run build` pass (only `no-img-element` warnings).

## Today’s Priorities (recommended order)
P0 = privacy/security correctness, P1 = shipping path, P2 = polish.

### P0) Commerce Safety (keep “ready”, launch behind “СКОРО”)
- Stripe commerce already exists, but keep it disabled by default for launch:
  - server flag: `MARKET_COMMERCE_ENABLED=false`
  - client flag: `NEXT_PUBLIC_MARKET_COMMERCE_ENABLED=false`
- Add webhook idempotency (store processed Stripe event IDs) to avoid double-processing.
- Add a fallback release path for `RESERVED` listings (webhook expiry is best-effort).

### P1) “Lazy user” fix (retention)
- Receipt import via OCR (photo -> parsed draft -> 1-tap confirm) for `LogEntry` + `Document` attachment.
- Bulk import for “existing build with missing history” (seed timeline quickly, then refine).

### P2) Minimal Tests / Smoke Scripts (before deploy)
- Add a repeatable smoke run (script or documented curl steps) to assert:
  - PRIVATE build not viewable via token
  - UNLISTED build requires token
  - revoked/expired token denied
  - view logging increments and dedup works

Acceptance:
- Repeatable verification before deploy.

## 1) Apply DB Changes (Postgres)
- Run `PRISMA_SCHEMA=prisma/schema.postgres.prisma npx prisma db push --schema prisma/schema.postgres.prisma` against your Neon DB.
- Confirm tables/columns exist:
  - `Car.slug`, `Car.buildStatus`, default `Car.visibility = UNLISTED`
  - `ShareLinkView`
  - `BuildTask`

Acceptance:
- App pages that touch these features work end-to-end in production DB (create car -> share link -> view by token -> views count increments).

## 2) Element-Level Privacy (Core Product)
Goal: every element on a passport can be `NONE | SELF | LINK | PUBLIC`, independent from build-level.

- Add visibility fields (safe defaults) to:
  - `Document.visibility` (default `SELF`)
  - `LogEntry.visibility` (default `SELF` or inherit build visibility)
  - (optional) `Modification.visibility` (default inherit log entry)
- Update `/build/[slug]` query to filter:
  - owner: sees everything
  - public view: only PUBLIC items
  - link view: LINK + PUBLIC items
- Add minimal owner UI on `/cars/[id]`:
  - per-document visibility toggle
  - per-log-entry visibility toggle (optional for v1)

Acceptance:
- A build can be `PUBLIC`, but documents can remain `SELF`.
- A build can be `UNLISTED`, and only selected items are visible via token.

## 3) Provenance-First Marketplace Rule
- Decide rule:
  - Option A: listings must reference a `Modification` (strict)
  - Option B: allow standalone but mark as `NO_EVIDENCE` and downgrade ranking (soft)
- Implement server-side enforcement in `app/api/market/listings/route.ts` and `app/api/market/listings/[id]/route.ts`.
- Update listing UI badges: docs count, TÜV status, mileage-on-part (where possible).

Acceptance:
- Cannot create a “provenance listing” without a referenced modification (if strict), or it is clearly labeled (if soft).

## 4) Consent Log UX (Owner View)
- Add owner-only view log section on `/cars/[id]`:
  - show share links with last viewed, unique viewers, total views
  - add “View details” per link (last 20 views)
- Add throttling/dedup on view logging (e.g., ignore same `viewerHash` within 10 minutes per shareLink).

Acceptance:
- Owner can answer “who/when viewed my passport” without exposing raw IP.

## 5) Tighten Server Validation (Strings -> Controlled Vocab)
Because SQLite schema doesn’t support Prisma enums in this repo, do runtime validation:
- Centralize allowed values:
  - `visibility`, `buildStatus`, `LogEntry.type`, `Modification.tuvStatus`, `PartListing.status`
- Validate on all write routes:
  - `app/api/cars/[id]/route.ts`
  - `app/api/cars/[id]/log-entries/route.ts`
  - `app/api/market/listings/*`
  - `app/api/events/*`

Acceptance:
- No route accepts arbitrary strings for these key fields.

## 6) Minimal Tests / Smoke Scripts
- Add a script or test plan that asserts:
  - PRIVATE build not viewable via token
  - UNLISTED build requires token
  - revoked/expired token denied
  - share view logging increments count

Acceptance:
- Repeatable verification before deploy.
